<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n del Sistema - SAP Multi-Regional</title>
    <style>
        :root {
            --sap-blue: #0070E0;
            --sap-light-blue: #E6F3FF;
            --sap-dark-blue: #003B6B;
            --sap-gray: #F7F7F7;
            --sap-border: #D9D9D9;
            --sap-text: #32363A;
            --sap-success: #107E3E;
            --sap-error: #E74C3C;
            --sap-warning: #F39C12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: '72', 'Helvetica Neue', Arial, sans-serif;
            background: var(--sap-gray);
            color: var(--sap-text);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--sap-dark-blue) 0%, var(--sap-blue) 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 400;
        }

        .header-actions {
            margin-top: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: var(--sap-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--sap-dark-blue);
        }

        .btn-success {
            background: var(--sap-success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .card h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--sap-dark-blue);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: auto;
        }

        .category-sap {
            background: var(--sap-light-blue);
            color: var(--sap-blue);
        }

        .category-general {
            background: #e9ecef;
            color: #495057;
        }

        .config-item {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--sap-border);
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--sap-text);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-description {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .config-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--sap-border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--sap-blue);
        }

        .config-meta {
            display: flex;
            gap: 20px;
            font-size: 11px;
            color: #6c757d;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--sap-text);
        }

        .spinner {
            border: 3px solid var(--sap-border);
            border-top: 3px solid var(--sap-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .save-section {
            position: sticky;
            bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
            text-align: right;
        }

        .changed-badge {
            background: var(--sap-warning);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 10px;
        }

        .page-checkbox {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-checkbox:hover {
            background: #e9ecef;
        }

        .page-checkbox input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .page-checkbox label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin: 0;
            flex: 1;
        }

        .page-icon {
            min-width: 20px;
            text-align: center;
            color: var(--sap-blue);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>‚öôÔ∏è Configuraci√≥n del Sistema</h1>
        <div class="header-actions">
            <a href="/dashboard" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
        </div>
    </header>

    <!-- Container -->
    <div class="container">
        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando configuraci√≥n...</p>
        </div>

        <!-- SAP Configuration -->
        <div id="sap-config" class="card" style="display: none;">
            <h2>
                üîå Configuraci√≥n de SAP Service Layer
                <span class="category-badge category-sap">SAP</span>
            </h2>

            <div class="config-item">
                <div class="config-label">
                    Service Layer URL
                    <span class="changed-badge" id="badge-sap_endpoint" style="display: none;">MODIFICADO</span>
                </div>
                <div class="config-description">
                    URL completa del SAP Service Layer (incluir puerto y trailing slash). Ejemplo: https://servidor:50000/
                </div>
                <input
                    type="text"
                    class="config-input"
                    id="sap_endpoint"
                    data-original=""
                    placeholder="https://sap-stiacmzdr-sl.skyinone.net:50000/"
                >
                <div class="config-meta">
                    <span>√öltima actualizaci√≥n: <span id="meta-sap_endpoint"></span></span>
                    <span>Por: <span id="by-sap_endpoint"></span></span>
                </div>
            </div>

            <div class="config-item">
                <div class="config-label">
                    Timeout (ms)
                    <span class="changed-badge" id="badge-sap_timeout" style="display: none;">MODIFICADO</span>
                </div>
                <div class="config-description">
                    Tiempo m√°ximo de espera para peticiones SAP en milisegundos
                </div>
                <input
                    type="number"
                    class="config-input"
                    id="sap_timeout"
                    data-original=""
                    placeholder="10000"
                    min="1000"
                    max="60000"
                >
                <div class="config-meta">
                    <span>√öltima actualizaci√≥n: <span id="meta-sap_timeout"></span></span>
                    <span>Por: <span id="by-sap_timeout"></span></span>
                </div>
            </div>

            <div class="config-item">
                <div class="config-label">
                    N√∫mero de Reintentos
                    <span class="changed-badge" id="badge-sap_retries" style="display: none;">MODIFICADO</span>
                </div>
                <div class="config-description">
                    N√∫mero de reintentos para peticiones SAP fallidas
                </div>
                <input
                    type="number"
                    class="config-input"
                    id="sap_retries"
                    data-original=""
                    placeholder="3"
                    min="0"
                    max="10"
                >
                <div class="config-meta">
                    <span>√öltima actualizaci√≥n: <span id="meta-sap_retries"></span></span>
                    <span>Por: <span id="by-sap_retries"></span></span>
                </div>
            </div>

            <div class="config-item">
                <div class="config-label">
                    Verificar SSL
                    <span class="changed-badge" id="badge-sap_verify_ssl" style="display: none;">MODIFICADO</span>
                </div>
                <div class="config-description">
                    Verificar certificados SSL en peticiones SAP (true/false)
                </div>
                <select class="config-input" id="sap_verify_ssl" data-original="">
                    <option value="true">S√≠ (Verificar certificados)</option>
                    <option value="false">No (Ignorar certificados)</option>
                </select>
                <div class="config-meta">
                    <span>√öltima actualizaci√≥n: <span id="meta-sap_verify_ssl"></span></span>
                    <span>Por: <span id="by-sap_verify_ssl"></span></span>
                </div>
            </div>
        </div>

        <!-- General Configuration -->
        <div id="general-config" class="card" style="display: none;">
            <h2>
                üì± Configuraci√≥n General
                <span class="category-badge category-general">GENERAL</span>
            </h2>

            <div class="config-item">
                <div class="config-label">
                    Nombre de la Aplicaci√≥n
                    <span class="changed-badge" id="badge-app_display_name" style="display: none;">MODIFICADO</span>
                </div>
                <div class="config-description">
                    Nombre visible de la aplicaci√≥n en el header y p√°ginas
                </div>
                <input
                    type="text"
                    class="config-input"
                    id="app_display_name"
                    data-original=""
                    placeholder="SAP Multi-Regional"
                >
                <div class="config-meta">
                    <span>√öltima actualizaci√≥n: <span id="meta-app_display_name"></span></span>
                    <span>Por: <span id="by-app_display_name"></span></span>
                </div>
            </div>
        </div>

        <!-- Groups & Pages Management -->
        <div id="groups-config" class="card" style="display: none;">
            <h2>
                üë• Gesti√≥n de Grupos y P√°ginas
                <span class="category-badge category-general">GRUPOS</span>
            </h2>

            <div class="config-description" style="margin-bottom: 20px;">
                Crea grupos para organizar usuarios y asigna qu√© p√°ginas puede ver cada grupo. Los usuarios heredan las p√°ginas de sus grupos.
            </div>

            <!-- Create New Group Section -->
            <div class="config-item" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <div class="config-label" style="font-size: 16px; color: var(--sap-dark-blue); margin-bottom: 15px;">
                    ‚ûï Crear Nuevo Grupo
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                            Nombre del Grupo *
                        </label>
                        <input
                            type="text"
                            class="config-input"
                            id="new-group-name"
                            placeholder="ej: Repuestos, Ventas, Finanzas"
                            style="margin: 0;"
                        >
                    </div>
                    <div>
                        <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                            Base de Datos SAP
                        </label>
                        <input
                            type="text"
                            class="config-input"
                            id="new-group-companydb"
                            placeholder="* (todas) o c√≥digo espec√≠fico"
                            value="*"
                            style="margin: 0;"
                        >
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px;">
                        Descripci√≥n *
                    </label>
                    <input
                        type="text"
                        class="config-input"
                        id="new-group-description"
                        placeholder="ej: Grupo para usuarios del departamento de repuestos"
                        style="margin: 0;"
                    >
                </div>

                <button class="btn btn-primary" onclick="createNewGroup()" style="width: 100%;">
                    ‚ûï Crear Grupo
                </button>
            </div>

            <div class="config-item">
                <div class="config-label">Seleccionar Grupo</div>
                <select class="config-input" id="selected-group" onchange="loadGroupPages()">
                    <option value="">Cargando grupos...</option>
                </select>
            </div>

            <div class="config-item" id="pages-checkboxes" style="display: none;">
                <div class="config-label">P√°ginas Disponibles</div>
                <div class="config-description">Selecciona las p√°ginas que este grupo puede ver</div>
                <div id="pages-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <div id="save-group-section" style="display: none; margin-top: 20px; text-align: right;">
                <button class="btn btn-success" onclick="saveGroupPages()">
                    üíæ Guardar P√°ginas del Grupo
                </button>
            </div>
        </div>

        <!-- Save Section -->
        <div class="save-section" id="save-section" style="display: none;">
            <button class="btn btn-success" onclick="saveChanges()">
                üíæ Guardar Cambios
            </button>
        </div>
    </div>

    <script>
        let configs = {};
        let hasChanges = false;

        // Check authentication
        function checkAuth() {
            const authData = localStorage.getItem('sapAuth');
            if (!authData) {
                window.location.href = '/login';
                return null;
            }

            try {
                const auth = JSON.parse(authData);

                // Only allow stifmolina2
                if (auth.username !== 'stifmolina2') {
                    showAlert('No tienes permisos para acceder a esta p√°gina', 'error');
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                    return null;
                }

                return auth;
            } catch (error) {
                window.location.href = '/login';
                return null;
            }
        }

        // Show alert
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;

            setTimeout(() => {
                alert.className = 'alert';
                alert.style.display = 'none';
            }, 5000);
        }

        // Load configuration
        async function loadConfig() {
            try {
                const auth = checkAuth();
                if (!auth) return;

                const response = await fetch('/api/admin/config', {
                    headers: {
                        'x-sap-username': auth.username
                    }
                });
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Error al cargar configuraci√≥n');
                }

                configs = {};
                data.configs.forEach(config => {
                    configs[config.key] = config;

                    const input = document.getElementById(config.key);
                    if (input) {
                        input.value = config.value;
                        input.dataset.original = config.value;

                        // Add change listener
                        input.addEventListener('input', () => checkForChanges());

                        // Update metadata
                        const metaEl = document.getElementById(`meta-${config.key}`);
                        if (metaEl && config.updatedAt) {
                            metaEl.textContent = new Date(config.updatedAt).toLocaleString();
                        }

                        const byEl = document.getElementById(`by-${config.key}`);
                        if (byEl && config.updatedBy) {
                            byEl.textContent = config.updatedBy;
                        }
                    }
                });

                // Show cards
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sap-config').style.display = 'block';
                document.getElementById('general-config').style.display = 'block';

            } catch (error) {
                console.error('Error loading config:', error);
                showAlert('Error al cargar configuraci√≥n: ' + error.message, 'error');
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Check for changes
        function checkForChanges() {
            hasChanges = false;

            Object.keys(configs).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    const originalValue = input.dataset.original;
                    const currentValue = input.value;
                    const badge = document.getElementById(`badge-${key}`);

                    if (originalValue !== currentValue) {
                        hasChanges = true;
                        if (badge) badge.style.display = 'inline-block';
                    } else {
                        if (badge) badge.style.display = 'none';
                    }
                }
            });

            document.getElementById('save-section').style.display = hasChanges ? 'block' : 'none';
        }

        // Save changes
        async function saveChanges() {
            const changedConfigs = [];

            Object.keys(configs).forEach(key => {
                const input = document.getElementById(key);
                if (input && input.dataset.original !== input.value) {
                    changedConfigs.push({
                        key: key,
                        value: input.value
                    });
                }
            });

            if (changedConfigs.length === 0) {
                showAlert('No hay cambios para guardar', 'error');
                return;
            }

            try {
                const auth = checkAuth();
                if (!auth) return;

                // Save each configuration
                for (const config of changedConfigs) {
                    const response = await fetch(`/api/admin/config/${config.key}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-sap-username': auth.username
                        },
                        body: JSON.stringify({ value: config.value })
                    });

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || `Error al guardar ${config.key}`);
                    }
                }

                showAlert(`‚úì ${changedConfigs.length} configuraci√≥n(es) guardada(s) correctamente`, 'success');

                // Reload configuration
                await loadConfig();
                hasChanges = false;
                document.getElementById('save-section').style.display = 'none';

            } catch (error) {
                console.error('Error saving config:', error);
                showAlert('Error al guardar configuraci√≥n: ' + error.message, 'error');
            }
        }

        // =====================================================
        // GESTI√ìN DE GRUPOS Y P√ÅGINAS
        // =====================================================

        let allRoles = [];
        let allPages = [];
        let currentRolePages = [];

        // Cargar grupos/roles
        async function loadGroups() {
            try {
                const auth = checkAuth();
                if (!auth) return;

                const response = await fetch('/api/admin/roles', {
                    headers: {
                        'x-sap-username': auth.username
                    }
                });
                const data = await response.json();

                if (data.success) {
                    allRoles = data.roles;
                    const select = document.getElementById('selected-group');
                    select.innerHTML = '<option value="">Seleccionar grupo...</option>';

                    allRoles.forEach(role => {
                        select.innerHTML += `<option value="${role.id}">${role.name} - ${role.description}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading groups:', error);
                showAlert('Error al cargar grupos', 'error');
            }
        }

        // Cargar todas las p√°ginas disponibles
        async function loadAllPages() {
            try {
                const auth = checkAuth();
                if (!auth) return;

                const response = await fetch('/api/admin/pages', {
                    headers: {
                        'x-sap-username': auth.username
                    }
                });
                const data = await response.json();

                if (data.success) {
                    allPages = data.pages;
                }
            } catch (error) {
                console.error('Error loading pages:', error);
            }
        }

        // Cargar p√°ginas de un grupo espec√≠fico
        async function loadGroupPages() {
            const roleId = document.getElementById('selected-group').value;

            if (!roleId) {
                document.getElementById('pages-checkboxes').style.display = 'none';
                document.getElementById('save-group-section').style.display = 'none';
                return;
            }

            try {
                const auth = checkAuth();
                if (!auth) return;

                // Obtener p√°ginas del rol
                const response = await fetch(`/api/admin/roles/${roleId}/pages`, {
                    headers: {
                        'x-sap-username': auth.username
                    }
                });
                const data = await response.json();

                if (data.success) {
                    currentRolePages = data.pages.map(p => p.id);
                    displayPagesCheckboxes();
                    document.getElementById('pages-checkboxes').style.display = 'block';
                    document.getElementById('save-group-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading group pages:', error);
                showAlert('Error al cargar p√°ginas del grupo', 'error');
            }
        }

        // Mostrar checkboxes de p√°ginas
        function displayPagesCheckboxes() {
            const container = document.getElementById('pages-list');
            container.innerHTML = '';

            allPages.forEach(page => {
                const isChecked = currentRolePages.includes(page.id);
                const checkboxId = `page-${page.id}`;

                container.innerHTML += `
                    <div class="page-checkbox">
                        <input
                            type="checkbox"
                            id="${checkboxId}"
                            value="${page.id}"
                            ${isChecked ? 'checked' : ''}
                        >
                        <label for="${checkboxId}">
                            <span class="page-icon"><i class="${page.icon || 'fas fa-file'}"></i></span>
                            <span>${page.name}</span>
                        </label>
                    </div>
                `;
            });
        }

        // Guardar p√°ginas del grupo
        async function saveGroupPages() {
            const roleId = document.getElementById('selected-group').value;

            if (!roleId) {
                showAlert('Selecciona un grupo primero', 'error');
                return;
            }

            // Obtener IDs de p√°ginas seleccionadas
            const selectedPages = [];
            allPages.forEach(page => {
                const checkbox = document.getElementById(`page-${page.id}`);
                if (checkbox && checkbox.checked) {
                    selectedPages.push(page.id);
                }
            });

            try {
                const auth = checkAuth();
                if (!auth) return;

                const response = await fetch(`/api/admin/roles/${roleId}/pages`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-sap-username': auth.username
                    },
                    body: JSON.stringify({ pageIds: selectedPages })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úì P√°ginas actualizadas para el grupo (${selectedPages.length} p√°ginas asignadas)`, 'success');
                    await loadGroupPages(); // Recargar para actualizar
                } else {
                    throw new Error(data.error || 'Error al guardar p√°ginas');
                }
            } catch (error) {
                console.error('Error saving group pages:', error);
                showAlert('Error al guardar p√°ginas: ' + error.message, 'error');
            }
        }

        // Crear nuevo grupo
        async function createNewGroup() {
            const name = document.getElementById('new-group-name').value.trim();
            const description = document.getElementById('new-group-description').value.trim();
            const companyDb = document.getElementById('new-group-companydb').value.trim() || '*';

            // Validar campos requeridos
            if (!name || !description) {
                showAlert('Por favor completa el nombre y la descripci√≥n del grupo', 'error');
                return;
            }

            try {
                const auth = checkAuth();
                if (!auth) return;

                const response = await fetch('/api/admin/roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-sap-username': auth.username
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        companyDb: companyDb
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(`‚úì Grupo "${name}" creado correctamente`, 'success');

                    // Limpiar formulario
                    document.getElementById('new-group-name').value = '';
                    document.getElementById('new-group-description').value = '';
                    document.getElementById('new-group-companydb').value = '*';

                    // Recargar lista de grupos
                    await loadGroups();

                    // Seleccionar el nuevo grupo autom√°ticamente
                    if (data.role && data.role.id) {
                        document.getElementById('selected-group').value = data.role.id;
                        await loadGroupPages();
                    }
                } else {
                    throw new Error(data.error || 'Error al crear grupo');
                }
            } catch (error) {
                console.error('Error creating group:', error);
                showAlert('Error al crear grupo: ' + error.message, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = checkAuth();
            if (auth) {
                await loadConfig();
                await loadGroups();
                await loadAllPages();

                // Mostrar la card de grupos
                document.getElementById('groups-config').style.display = 'block';
            }
        });
    </script>
</body>
</html>
