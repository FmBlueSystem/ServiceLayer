<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading... - Ã“rdenes de Venta</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/app-theme.css" rel="stylesheet">
    <style>
        /* Page-specific styles only - variables now in app-theme.css */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: '72', 'Helvetica Neue', Arial, sans-serif;
            background: var(--sap-light-gray);
            color: var(--sap-text);
            line-height: 1.4;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--sap-dark-blue) 0%, var(--sap-blue) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 16px 24px;
            background: var(--sap-gray);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom-color: var(--sap-blue);
        }

        .tab:hover:not(.active) {
            background: #f0f0f0;
        }

        /* Content Panel */
        .content-panel {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--sap-dark-blue);
            margin-bottom: 16px;
            border-bottom: 2px solid var(--sap-light-blue);
            padding-bottom: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--sap-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            padding: 12px;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--sap-blue);
            box-shadow: 0 0 0 2px rgba(0, 112, 224, 0.2);
        }

        .form-select {
            padding: 12px;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Search Section */
        .search-section {
            background: var(--sap-light-blue);
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }

        .search-btn {
            background: var(--sap-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: var(--sap-dark-blue);
        }

        /* Customer List */
        .customer-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .customer-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: var(--sap-light-blue);
        }

        .customer-item.selected {
            background: var(--sap-blue);
            color: white;
        }

        .customer-code {
            font-weight: 600;
            font-size: 14px;
        }

        .customer-name {
            font-size: 12px;
            color: var(--sap-medium-gray);
        }

        .customer-item.selected .customer-name {
            color: rgba(255,255,255,0.8);
        }

        /* Items Table */
        .items-section {
            margin-top: 24px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .add-item-btn {
            background: var(--sap-success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .add-item-btn:hover {
            background: #0a5f2e;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .items-table th {
            background: var(--sap-gray);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--sap-border);
        }

        .items-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .items-table tr:hover {
            background: var(--sap-light-blue);
        }

        .item-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            font-size: 14px;
        }

        .remove-item-btn {
            background: var(--sap-error);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Actions */
        .actions-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--sap-border);
        }

        .order-total {
            font-size: 18px;
            font-weight: 600;
            color: var(--sap-dark-blue);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--sap-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--sap-dark-blue);
        }

        .btn-secondary {
            background: var(--sap-border);
            color: var(--sap-text);
        }

        .btn-secondary:hover {
            background: var(--sap-medium-gray);
            color: white;
        }

        /* Orders List */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
        }

        .orders-table th {
            background: var(--sap-gray);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--sap-border);
        }

        .orders-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .orders-table tr:hover {
            background: var(--sap-light-blue);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-open {
            background: var(--sap-warning);
            color: white;
        }

        .status-closed {
            background: var(--sap-success);
            color: white;
        }

        /* Alert Messages */
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.success {
            background: #D4F5D4;
            border: 1px solid var(--sap-success);
            color: var(--sap-success);
        }

        .alert.error {
            background: #FFE6E6;
            border: 1px solid var(--sap-error);
            color: var(--sap-error);
        }

        .alert.warning {
            background: #FFF3CD;
            border: 1px solid var(--sap-warning);
            color: #856404;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--sap-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
            }

            .main-content {
                padding: 0 16px;
                margin: 16px auto;
            }

            .form-grid,
            .search-grid {
                grid-template-columns: 1fr;
            }

            .actions-section {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-left">
            <div class="app-logo" id="appLogo">Loading...</div>
            <div class="page-title">ðŸ“‹ Ã“rdenes de Venta</div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <i class="fas fa-user"></i>
                <span id="username">Usuario</span>
            </div>
            <button class="btn btn-secondary" onclick="goBack()" style="margin-right: 8px;">
                <i class="fas fa-arrow-left"></i> Regresar
            </button>
            <button class="btn btn-secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Cerrar SesiÃ³n
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Alert Messages -->
        <div id="alert" class="alert"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="create">Crear Orden</button>
            <button class="tab" data-tab="list">Consultar Ã“rdenes</button>
        </div>

        <!-- Content Panel -->
        <div class="content-panel">
            <!-- Create Order Tab -->
            <div id="create-tab" class="tab-content active">
                <form id="salesOrderForm">
                    <!-- Customer Selection -->
                    <div class="form-section">
                        <h3 class="section-title">SelecciÃ³n de Cliente</h3>
                        
                        <!-- Customer Search -->
                        <div class="search-section">
                            <div class="search-grid">
                                <div class="form-group">
                                    <label class="form-label">CÃ³digo de Cliente</label>
                                    <input type="text" id="customerCodeSearch" class="form-input" placeholder="Buscar por cÃ³digo...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nombre de Cliente</label>
                                    <input type="text" id="customerNameSearch" class="form-input" placeholder="Buscar por nombre...">
                                </div>
                                <button type="button" id="searchCustomersBtn" class="search-btn">Buscar</button>
                            </div>
                        </div>

                        <!-- Customer List -->
                        <div id="customerList" class="customer-list" style="display: none;"></div>

                        <!-- Selected Customer Info -->
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Cliente Seleccionado</label>
                                <input type="text" id="selectedCustomerCode" class="form-input" readonly placeholder="CÃ³digo del cliente">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombre del Cliente</label>
                                <input type="text" id="selectedCustomerName" class="form-input" readonly placeholder="Nombre del cliente">
                            </div>
                        </div>
                    </div>

                    <!-- Order Information -->
                    <div class="form-section">
                        <h3 class="section-title">InformaciÃ³n de la Orden</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Fecha de Documento</label>
                                <input type="date" id="docDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Entrega</label>
                                <input type="date" id="docDueDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CompaÃ±Ã­a</label>
                                <select id="companyDB" class="form-select" required>
                                    <option value="">Seleccionar compaÃ±Ã­a...</option>
                                    <option value="SBO_GT_STIA_PROD">Guatemala</option>
                                    <option value="SBO_HO_STIA_PROD">Honduras</option>
                                    <option value="SBO_PA_STIA_PROD">PanamÃ¡</option>
                                    <option value="SBO_STIACR_PROD">Costa Rica</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comentarios</label>
                            <textarea id="comments" class="form-input" rows="3" placeholder="Comentarios adicionales..."></textarea>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="form-section items-section">
                        <div class="items-header">
                            <h3 class="section-title">ArtÃ­culos de la Orden</h3>
                            <button type="button" id="addItemBtn" class="add-item-btn">+ Agregar ArtÃ­culo</button>
                        </div>

                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>CÃ³digo</th>
                                    <th>DescripciÃ³n</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Actions -->
                    <div class="actions-section">
                        <div class="order-total">
                            Total: <span id="orderTotal">$0.00</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">Limpiar</button>
                            <button type="submit" class="btn btn-primary">Crear Orden de Venta</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- List Orders Tab -->
            <div id="list-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Consultar Ã“rdenes de Venta</h3>
                    
                    <!-- Search Filters -->
                    <div class="search-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">NÃºmero de Orden</label>
                                <input type="number" id="orderNumSearch" class="form-input" placeholder="Buscar por nÃºmero...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CÃ³digo de Cliente</label>
                                <input type="text" id="orderCustomerSearch" class="form-input" placeholder="Buscar por cliente...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha Desde</label>
                                <input type="date" id="dateFromSearch" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha Hasta</label>
                                <input type="date" id="dateToSearch" class="form-input">
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 16px;">
                            <button type="button" id="searchOrdersBtn" class="search-btn">Buscar Ã“rdenes</button>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="ordersLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                    </div>

                    <!-- Orders Table -->
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>NÃºmero</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>CompaÃ±Ã­a</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sapAuth = null;
        let customers = [];
        let selectedCustomer = null;
        let orderItems = [];

        // Load app configuration
        async function loadAppConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Update app name in all locations
                document.getElementById('pageTitle').textContent = `${config.appName} - Ã“rdenes de Venta`;
                document.getElementById('appLogo').textContent = config.appName;
                
                console.log('App configuration loaded:', config);
            } catch (error) {
                console.error('Error loading app configuration:', error);
                // Fallback to default
                const fallbackName = 'My Application';
                document.getElementById('pageTitle').textContent = `${fallbackName} - Ã“rdenes de Venta`;
                document.getElementById('appLogo').textContent = fallbackName;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAppConfig();
            checkAuthentication();
            initializeTabs();
            initializeForm();
            setDefaultDates();
        });

        // Check authentication
        function checkAuthentication() {
            const authData = localStorage.getItem('sapAuth');
            
            if (!authData) {
                showAlert('Debe iniciar sesiÃ³n para acceder a este mÃ³dulo', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            try {
                sapAuth = JSON.parse(authData);
                document.getElementById('username').textContent = sapAuth.username;
                console.log(`Sesiones activas: ${sapAuth.successCount}/${sapAuth.totalDatabases}`);
            } catch (error) {
                console.error('Error parsing auth data:', error);
                showAlert('Error de autenticaciÃ³n. Inicie sesiÃ³n nuevamente.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            }
        }

        // Initialize tabs
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;

                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update active content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${targetTab}-tab`) {
                            content.classList.add('active');
                        }
                    });

                    // Load orders if switching to list tab
                    if (targetTab === 'list') {
                        loadOrdersForAllCompanies();
                    }
                });
            });
        }

        // Initialize form
        function initializeForm() {
            // Customer search
            document.getElementById('searchCustomersBtn').addEventListener('click', searchCustomers);
            
            // Add item button
            document.getElementById('addItemBtn').addEventListener('click', addOrderItem);
            
            // Form submission
            document.getElementById('salesOrderForm').addEventListener('submit', createSalesOrder);
            
            // Search orders
            document.getElementById('searchOrdersBtn').addEventListener('click', searchOrders);
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('docDate').value = today;
            document.getElementById('docDueDate').value = nextWeek;
        }

        // Search customers
        async function searchCustomers() {
            const customerCode = document.getElementById('customerCodeSearch').value.trim();
            const customerName = document.getElementById('customerNameSearch').value.trim();
            const companyDB = document.getElementById('companyDB').value;

            if (!companyDB) {
                showAlert('Debe seleccionar una compaÃ±Ã­a primero', 'warning');
                return;
            }

            if (!customerCode && !customerName) {
                showAlert('Ingrese un criterio de bÃºsqueda', 'warning');
                return;
            }

            const session = getSessionForCompany(companyDB);
            if (!session) {
                showAlert(`No hay sesiÃ³n activa para la compaÃ±Ã­a seleccionada`, 'error');
                return;
            }

            try {
                showAlert('Buscando clientes...', 'info');

                const response = await fetch('/api/sap/business-partners', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        filters: {
                            cardCode: customerCode,
                            cardName: customerName,
                            cardType: 'C', // Customer type
                            limit: 20
                        }
                    })
                });

                const result = await response.json();
                
                if (result.success && result.data.value) {
                    customers = result.data.value;
                    displayCustomers(customers);
                    hideAlert();
                } else {
                    showAlert('No se encontraron clientes con los criterios especificados', 'warning');
                }

            } catch (error) {
                console.error('Error searching customers:', error);
                showAlert('Error al buscar clientes: ' + error.message, 'error');
            }
        }

        // Display customers
        function displayCustomers(customers) {
            const customerList = document.getElementById('customerList');
            
            if (customers.length === 0) {
                customerList.style.display = 'none';
                return;
            }

            customerList.innerHTML = '';
            customers.forEach(customer => {
                const customerItem = document.createElement('div');
                customerItem.className = 'customer-item';
                customerItem.innerHTML = `
                    <div class="customer-code">${customer.CardCode}</div>
                    <div class="customer-name">${customer.CardName}</div>
                `;
                
                customerItem.addEventListener('click', () => selectCustomer(customer));
                customerList.appendChild(customerItem);
            });

            customerList.style.display = 'block';
        }

        // Select customer
        function selectCustomer(customer) {
            selectedCustomer = customer;
            
            // Update form fields
            document.getElementById('selectedCustomerCode').value = customer.CardCode;
            document.getElementById('selectedCustomerName').value = customer.CardName;
            
            // Update UI
            document.querySelectorAll('.customer-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            event.target.closest('.customer-item').classList.add('selected');
            
            // Hide customer list
            setTimeout(() => {
                document.getElementById('customerList').style.display = 'none';
            }, 500);
        }

        // Add order item
        function addOrderItem() {
            const tableBody = document.getElementById('itemsTableBody');
            const itemId = Date.now();
            
            const row = document.createElement('tr');
            row.dataset.itemId = itemId;
            row.innerHTML = `
                <td><input type="text" class="item-input" placeholder="CÃ³digo del artÃ­culo" onchange="updateItemTotal(${itemId})"></td>
                <td><input type="text" class="item-input" placeholder="DescripciÃ³n"></td>
                <td><input type="number" class="item-input" min="1" value="1" onchange="updateItemTotal(${itemId})"></td>
                <td><input type="number" class="item-input" min="0" step="0.01" value="0" onchange="updateItemTotal(${itemId})"></td>
                <td><span class="item-total">$0.00</span></td>
                <td><button type="button" class="remove-item-btn" onclick="removeItem(${itemId})">Eliminar</button></td>
            `;
            
            tableBody.appendChild(row);
        }

        // Update item total
        function updateItemTotal(itemId) {
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            const quantity = parseFloat(row.children[2].querySelector('input').value) || 0;
            const price = parseFloat(row.children[3].querySelector('input').value) || 0;
            const total = quantity * price;
            
            row.children[4].querySelector('.item-total').textContent = `$${total.toFixed(2)}`;
            updateOrderTotal();
        }

        // Remove item
        function removeItem(itemId) {
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            row.remove();
            updateOrderTotal();
        }

        // Update order total
        function updateOrderTotal() {
            const itemTotals = document.querySelectorAll('.item-total');
            let orderTotal = 0;
            
            itemTotals.forEach(totalElement => {
                const value = parseFloat(totalElement.textContent.replace('$', ''));
                orderTotal += value;
            });
            
            document.getElementById('orderTotal').textContent = `$${orderTotal.toFixed(2)}`;
        }

        // Create sales order
        async function createSalesOrder(event) {
            event.preventDefault();
            
            if (!selectedCustomer) {
                showAlert('Debe seleccionar un cliente', 'error');
                return;
            }

            const companyDB = document.getElementById('companyDB').value;
            if (!companyDB) {
                showAlert('Debe seleccionar una compaÃ±Ã­a', 'error');
                return;
            }

            // Validate items
            const itemRows = document.querySelectorAll('#itemsTableBody tr');
            if (itemRows.length === 0) {
                showAlert('Debe agregar al menos un artÃ­culo', 'error');
                return;
            }

            // Prepare document lines
            const documentLines = [];
            let isValid = true;

            itemRows.forEach((row, index) => {
                const itemCode = row.children[0].querySelector('input').value.trim();
                const description = row.children[1].querySelector('input').value.trim();
                const quantity = parseFloat(row.children[2].querySelector('input').value);
                const price = parseFloat(row.children[3].querySelector('input').value);

                if (!itemCode || !quantity || !price) {
                    showAlert(`ArtÃ­culo ${index + 1}: CÃ³digo, cantidad y precio son obligatorios`, 'error');
                    isValid = false;
                    return;
                }

                documentLines.push({
                    ItemCode: itemCode,
                    ItemDescription: description || itemCode,
                    Quantity: quantity,
                    Price: price,
                    LineNum: index
                });
            });

            if (!isValid) return;

            const session = getSessionForCompany(companyDB);
            if (!session) {
                showAlert('No hay sesiÃ³n activa para la compaÃ±Ã­a seleccionada', 'error');
                return;
            }

            const orderData = {
                CardCode: selectedCustomer.CardCode,
                CardName: selectedCustomer.CardName,
                DocDate: document.getElementById('docDate').value,
                DocDueDate: document.getElementById('docDueDate').value,
                Comments: document.getElementById('comments').value,
                DocumentLines: documentLines
            };

            try {
                showAlert('Creando orden de venta...', 'info');

                const response = await fetch('/api/sap/create-sales-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        orderData: orderData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`âœ… Orden de venta ${result.docNum} creada exitosamente`, 'success');
                    clearForm();
                } else {
                    showAlert('Error al crear la orden: ' + (result.error || 'Error desconocido'), 'error');
                }

            } catch (error) {
                console.error('Error creating sales order:', error);
                showAlert('Error al crear la orden: ' + error.message, 'error');
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('salesOrderForm').reset();
            document.getElementById('selectedCustomerCode').value = '';
            document.getElementById('selectedCustomerName').value = '';
            document.getElementById('itemsTableBody').innerHTML = '';
            document.getElementById('orderTotal').textContent = '$0.00';
            document.getElementById('customerList').style.display = 'none';
            
            selectedCustomer = null;
            customers = [];
            orderItems = [];
            
            setDefaultDates();
        }

        // Load orders for all companies
        async function loadOrdersForAllCompanies() {
            const ordersTableBody = document.getElementById('ordersTableBody');
            ordersTableBody.innerHTML = '';
            
            showOrdersLoading(true);

            for (const result of sapAuth.sessions) {
                if (result.success) {
                    await loadOrdersForCompany(result.companyDB, result.sessionId);
                }
            }

            showOrdersLoading(false);
        }

        // Load orders for specific company
        async function loadOrdersForCompany(companyDB, sessionId) {
            try {
                const response = await fetch('/api/sap/sales-orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        companyDB: companyDB,
                        filters: { limit: 20 }
                    })
                });

                const result = await response.json();
                
                if (result.success && result.data.value) {
                    displayOrders(result.data.value, companyDB);
                }

            } catch (error) {
                console.error(`Error loading orders for ${companyDB}:`, error);
            }
        }

        // Display orders
        function displayOrders(orders, companyDB) {
            const ordersTableBody = document.getElementById('ordersTableBody');
            const companyName = getCompanyName(companyDB);
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.DocNum}</td>
                    <td>${order.CardCode} - ${order.CardName}</td>
                    <td>${new Date(order.DocDate).toLocaleDateString()}</td>
                    <td>$${(order.DocTotal || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${order.DocumentStatus === 'O' ? 'status-open' : 'status-closed'}">${order.DocumentStatus === 'O' ? 'Abierta' : 'Cerrada'}</span></td>
                    <td>${companyName}</td>
                `;
                ordersTableBody.appendChild(row);
            });
        }

        // Search orders
        async function searchOrders() {
            const orderNum = document.getElementById('orderNumSearch').value.trim();
            const customerCode = document.getElementById('orderCustomerSearch').value.trim();
            const dateFrom = document.getElementById('dateFromSearch').value;
            const dateTo = document.getElementById('dateToSearch').value;

            const ordersTableBody = document.getElementById('ordersTableBody');
            ordersTableBody.innerHTML = '';
            
            showOrdersLoading(true);

            const filters = {};
            if (orderNum) filters.docNum = orderNum;
            if (customerCode) filters.cardCode = customerCode;
            if (dateFrom) filters.dateFrom = dateFrom;
            if (dateTo) filters.dateTo = dateTo;

            for (const result of sapAuth.sessions) {
                if (result.success) {
                    try {
                        const response = await fetch('/api/sap/sales-orders', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sessionId: result.sessionId,
                                companyDB: result.companyDB,
                                filters: { ...filters, limit: 50 }
                            })
                        });

                        const searchResult = await response.json();
                        
                        if (searchResult.success && searchResult.data.value) {
                            displayOrders(searchResult.data.value, result.companyDB);
                        }

                    } catch (error) {
                        console.error(`Error searching orders for ${result.companyDB}:`, error);
                    }
                }
            }

            showOrdersLoading(false);
        }

        // Helper functions
        function getSessionForCompany(companyDB) {
            if (!sapAuth || !sapAuth.sessions) return null;
            
            for (const result of sapAuth.sessions) {
                if (result.companyDB === companyDB && result.success) {
                    return result;
                }
            }
            return null;
        }

        function getCompanyName(companyDB) {
            const companyNames = {
                'SBO_GT_STIA_PROD': 'Guatemala',
                'SBO_HO_STIA_PROD': 'Honduras',
                'SBO_PA_STIA_PROD': 'PanamÃ¡',
                'SBO_STIACR_PROD': 'Costa Rica'
            };
            return companyNames[companyDB] || companyDB;
        }

        function showOrdersLoading(show) {
            const loadingElement = document.getElementById('ordersLoading');
            loadingElement.style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    hideAlert();
                }, 5000);
            }
        }

        function hideAlert() {
            const alert = document.getElementById('alert');
            alert.style.display = 'none';
        }

        // Navigation functions
        function goBack() {
            window.location.href = '/dashboard';
        }

        async function logout() {
            try {
                // Clear localStorage
                localStorage.removeItem('sapAuth');
                
                // Redirect to login
                window.location.href = '/login';
            } catch (error) {
                console.error('Error during logout:', error);
                window.location.href = '/login';
            }
        }

        console.log('Sales Orders page loaded successfully');
    </script>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-left">
                <span class="bluesystem-brand">BlueSystemIO</span>
                <span>2025</span>
            </div>
            <div class="footer-right">
                <span>Version 1.0.0</span>
            </div>
        </div>
    </footer>
</body>
</html>