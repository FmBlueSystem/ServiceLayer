# üìã INSTRUCCIONES PARA CLAUDE

Este archivo contiene instrucciones permanentes para Claude al trabajar en este proyecto.

---

## üÜï AGREGAR NUEVAS P√ÅGINAS AL SISTEMA

**IMPORTANTE:** Cada vez que se cree una **nueva p√°gina HTML** en el directorio `public/`, se deben completar **TODOS** los siguientes pasos autom√°ticamente:

### ‚úÖ Checklist Obligatorio para Nuevas P√°ginas

#### 1. Crear el archivo HTML
- Ubicaci√≥n: `/public/nombre-pagina.html`
- Debe incluir:
  - Sistema de autenticaci√≥n (`checkAuth()`)
  - Session Manager (`/js/sessionManager.js`)
  - Usar `fetchWithAutoRenewal()` en lugar de `fetch()` para llamadas SAP
  - Men√∫ de navegaci√≥n est√°ndar
  - Estilos del tema (`/css/app-theme.css`)

#### 2. Crear migraci√≥n SQL
- Ubicaci√≥n: `/database/migrations/XXX_add_nombre_pagina.sql`
- Formato del archivo:

```sql
-- =====================================================
-- AGREGAR P√ÅGINA: NOMBRE DE LA P√ÅGINA
-- =====================================================
-- Fecha: YYYY-MM-DD
-- Descripci√≥n: Breve descripci√≥n de la funcionalidad

-- Insertar la nueva p√°gina
INSERT INTO pages (name, path, icon, description, display_order, is_active) VALUES
('Nombre Visible', '/nombre-pagina.html', 'fas fa-icono', 'Descripci√≥n de la funcionalidad', <ORDER>, true)
ON CONFLICT (path) DO UPDATE SET
    name = EXCLUDED.name,
    icon = EXCLUDED.icon,
    description = EXCLUDED.description,
    display_order = EXCLUDED.display_order,
    is_active = EXCLUDED.is_active,
    updated_at = CURRENT_TIMESTAMP;

-- Asignar la p√°gina al rol super_admin (id = 1)
INSERT INTO role_pages (role_id, page_id, granted_by)
SELECT 1, id, 'system'
FROM pages
WHERE path = '/nombre-pagina.html'
ON CONFLICT (role_id, page_id) DO NOTHING;

-- Verificar la inserci√≥n
SELECT
    p.id,
    p.name,
    p.path,
    p.icon,
    p.description,
    p.display_order,
    p.is_active,
    CASE
        WHEN EXISTS (SELECT 1 FROM role_pages rp WHERE rp.page_id = p.id AND rp.role_id = 1)
        THEN 'Asignado a super_admin'
        ELSE 'NO asignado'
    END as permission_status
FROM pages
WHERE path = '/nombre-pagina.html';
```

#### 3. Ejecutar la migraci√≥n
```bash
node scripts/run-migration.js XXX_add_nombre_pagina.sql
```

#### 4. Verificar la integraci√≥n
```bash
node scripts/verify-pages.js
```

#### 5. Verificar en API
```bash
curl -k -s https://10.13.1.83:3443/api/admin/menu/my-pages -H "x-sap-username: stifmolina2"
```

La nueva p√°gina debe aparecer en el JSON retornado.

---

## üîë GU√çA DE ICONOS FONT AWESOME

Usar iconos apropiados seg√∫n la funcionalidad:

| Funcionalidad | Icono | Clase |
|--------------|-------|-------|
| Dashboard/Inicio | üè† | `fas fa-home` |
| Inventario/Almac√©n | üè≠ | `fas fa-warehouse` |
| Art√≠culos/Productos | üì¶ | `fas fa-box` |
| Ventas | üõí | `fas fa-shopping-cart` |
| Ofertas/Cotizaciones | üìÑ | `fas fa-file-invoice` |
| Reportes/Gr√°ficos | üìä | `fas fa-chart-bar` |
| Configuraci√≥n | ‚öôÔ∏è | `fas fa-cog` |
| Usuarios/Permisos | üõ°Ô∏è | `fas fa-user-shield` |
| Documentos | üìã | `fas fa-clipboard-list` |
| Finanzas | üíµ | `fas fa-dollar-sign` |
| Herramientas | üîß | `fas fa-wrench` |
| Pruebas/Test | üß™ | `fas fa-vial` |

Ver m√°s iconos en: https://fontawesome.com/icons

---

## üìä ORDEN DE VISUALIZACI√ìN (display_order)

El campo `display_order` determina el orden en que aparecen las p√°ginas en el dashboard.

**Convenci√≥n actual:**
- 1-10: Dashboards principales
- 11-20: Dashboards secundarios
- 21-30: Cat√°logos y consultas
- 31-50: Transacciones (ventas, compras)
- 51-70: Reportes
- 71-80: Herramientas
- 81-90: Pruebas/Diagn√≥stico
- 91-100: Administraci√≥n y configuraci√≥n

**P√°ginas actuales:**
```
10  - Dashboard principal
11  - Dashboard Inventario
20  - Art√≠culos
30  - Fichas T√©cnicas
40  - Ofertas de Venta
50  - √ìrdenes de Venta
60  - Tipos de Cambio
70  - Reportes EEFF
80  - Test UDOs
90  - Admin Permisos
100 - Config Sistema
```

---

## üîê SISTEMA DE ROLES Y PERMISOS

### Roles Predefinidos

1. **super_admin** (ID: 1)
   - Acceso total al sistema
   - Todas las p√°ginas nuevas se asignan autom√°ticamente a este rol

2. **admin** (ID: 2)
   - Acceso administrativo limitado

3. **user** (ID: 3)
   - Usuario est√°ndar

4. **Servicio Tecnico** (ID: 4)
   - Rol espec√≠fico para t√©cnicos

### Asignaci√≥n de Permisos

**Por defecto:** Todas las p√°ginas nuevas se asignan al rol `super_admin`.

**Para asignar a otros roles:**
```sql
INSERT INTO role_pages (role_id, page_id, granted_by)
SELECT <ROLE_ID>, id, 'system'
FROM pages
WHERE path = '/nombre-pagina.html'
ON CONFLICT (role_id, page_id) DO NOTHING;
```

---

## üõ†Ô∏è SCRIPTS √öTILES

### 1. Ejecutar migraci√≥n
```bash
node scripts/run-migration.js <archivo.sql>
```

### 2. Verificar p√°ginas
```bash
node scripts/verify-pages.js
```

### 3. Crear backup de base de datos (Windows)
```powershell
.\scripts\windows\backup-database.ps1
```

### 4. Verificar estado del sistema (Windows)
```powershell
.\scripts\windows\check-status.ps1
```

---

## üìù PLANTILLA DE P√ÅGINA HTML

Al crear una nueva p√°gina, usar esta estructura base:

```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nombre de la P√°gina - SAP Service Layer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- App Theme -->
    <link rel="stylesheet" href="/css/app-theme.css">

    <!-- Session Manager -->
    <script src="/js/sessionManager.js"></script>

    <!-- Inactivity Manager - Auto logout despu√©s de 15 minutos -->
    <script src="/js/inactivityManager.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard.html">
                <i class="fas fa-industry"></i> SAP Service Layer
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="navbar-text text-light me-3">
                            <i class="fas fa-user"></i>
                            <span id="displayUsername">Usuario</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard.html">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <h1><i class="fas fa-icono"></i> Nombre de la P√°gina</h1>

        <!-- Contenido espec√≠fico de la p√°gina -->

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts -->
    <script>
        // Verificar autenticaci√≥n
        function checkAuth() {
            const username = localStorage.getItem('username');
            const sessionId = localStorage.getItem('sessionId');

            if (!username || !sessionId) {
                window.location.href = '/login-simple.html';
                return false;
            }

            document.getElementById('displayUsername').textContent = username;
            return true;
        }

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = '/login-simple.html';
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;

            // Inicializar funcionalidades espec√≠ficas de la p√°gina
        });
    </script>
</body>
</html>
```

---

## üîÑ SESSION RENEWAL

**IMPORTANTE:** Todas las llamadas al API de SAP deben usar `fetchWithAutoRenewal()`:

```javascript
// ‚ùå INCORRECTO
const response = await fetch('/api/sap/items', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
});

// ‚úÖ CORRECTO
const response = await fetchWithAutoRenewal('/api/sap/items', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
});
```

Esto asegura que si la sesi√≥n SAP expira, se renueve autom√°ticamente sin que el usuario tenga que volver a iniciar sesi√≥n.

---

## ‚è±Ô∏è AUTO-LOGOUT POR INACTIVIDAD

**IMPORTANTE:** El sistema incluye un gestor de inactividad que cierra autom√°ticamente la sesi√≥n despu√©s de 15 minutos sin actividad del usuario.

### Caracter√≠sticas

- **Tiempo de Inactividad**: 15 minutos (configurable)
- **Advertencia**: Se muestra una notificaci√≥n 2 minutos antes del logout (a los 13 minutos)
- **Eventos Monitoreados**: Mouse, teclado, scroll, touch, clicks
- **Auto-inicializaci√≥n**: Se activa autom√°ticamente en todas las p√°ginas excepto login

### Configuraci√≥n Personalizada (Opcional)

```javascript
// Personalizar tiempos en una p√°gina espec√≠fica
document.addEventListener('DOMContentLoaded', function() {
    // Configurar 30 minutos de inactividad en lugar de 15
    InactivityManager.configure({
        inactivityMinutes: 30,  // Tiempo total hasta logout
        warningMinutes: 28,     // Tiempo hasta mostrar advertencia
        loginUrl: '/login-simple.html',  // URL de redirecci√≥n
        debug: false  // Desactivar logs en producci√≥n
    });
});
```

### Deshabilitar en P√°ginas Espec√≠ficas

```javascript
// Detener el manager de inactividad (si es necesario)
InactivityManager.stop();
```

### Notificaciones

1. **Advertencia (13 minutos)**: Modal animado con opci√≥n "Mantener Sesi√≥n Activa"
2. **Logout (15 minutos)**: Notificaci√≥n de cierre de sesi√≥n y redirecci√≥n autom√°tica

El sistema limpia completamente el localStorage y sessionStorage antes de redirigir al login.

---

## üì¶ ESTRUCTURA DEL PROYECTO

```
my-app/
‚îú‚îÄ‚îÄ public/                    # P√°ginas HTML del frontend
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îú‚îÄ‚îÄ articulos.html
‚îÇ   ‚îú‚îÄ‚îÄ dashboard-inventario.html
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.js              # Punto de entrada
‚îÇ   ‚îú‚îÄ‚îÄ routes/               # Rutas del API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sap.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.js
‚îÇ   ‚îú‚îÄ‚îÄ services/             # L√≥gica de negocio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sapService.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sessionRenewalService.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ permissionService.js
‚îÇ   ‚îî‚îÄ‚îÄ middleware/           # Middleware Express
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/           # Scripts SQL de migraci√≥n
‚îú‚îÄ‚îÄ scripts/                  # Scripts de utilidad
‚îÇ   ‚îú‚îÄ‚îÄ run-migration.js
‚îÇ   ‚îú‚îÄ‚îÄ verify-pages.js
‚îÇ   ‚îî‚îÄ‚îÄ windows/             # Scripts PowerShell para Windows
‚îî‚îÄ‚îÄ docs/                     # Documentaci√≥n adicional
```

---

## üö® ERRORES COMUNES AL AGREGAR P√ÅGINAS

### 1. ‚ùå No agregar la p√°gina a la base de datos
**Resultado:** La p√°gina existe pero no aparece en el dashboard din√°mico.

**Soluci√≥n:** Crear y ejecutar la migraci√≥n SQL.

### 2. ‚ùå No asignar permisos a ning√∫n rol
**Resultado:** La p√°gina existe pero nadie puede verla.

**Soluci√≥n:** Asignar al menos al rol `super_admin`.

### 3. ‚ùå No incluir sessionManager.js
**Resultado:** La sesi√≥n expira y el usuario debe volver a loguearse.

**Soluci√≥n:** Incluir `<script src="/js/sessionManager.js"></script>` y usar `fetchWithAutoRenewal()`.

### 4. ‚ùå No verificar autenticaci√≥n
**Resultado:** Usuarios no autenticados pueden acceder a la p√°gina.

**Soluci√≥n:** Incluir funci√≥n `checkAuth()` y llamarla en `DOMContentLoaded`.

### 5. ‚ùå Usar display_order duplicado
**Resultado:** Orden impredecible en el dashboard.

**Soluci√≥n:** Consultar las p√°ginas existentes y elegir un n√∫mero √∫nico seg√∫n la convenci√≥n.

---

## üìö DOCUMENTACI√ìN RELACIONADA

- **Sistema de Permisos:** `/IMPLEMENTACION_PERMISOS.md`
- **Renovaci√≥n de Sesi√≥n Single-Database:** `/RENOVACION_AUTOMATICA_SESION.md`
- **Renovaci√≥n de Sesi√≥n Multi-Database:** `/RENOVACION_MULTI_DATABASE.md`
- **Migraci√≥n a Windows:** `/MIGRACION_WINDOWS_SERVER.md`
- **Gu√≠a de Ofertas:** `/OFERTAS_VENTA_GUIA_INTEGRACION.md`

---

## üéØ RESUMEN: PROCESO COMPLETO

Cuando se te pida crear una nueva p√°gina:

1. ‚úÖ **Crear** el archivo HTML en `/public/`
2. ‚úÖ **Incluir** Session Manager y autenticaci√≥n
3. ‚úÖ **Crear** migraci√≥n SQL en `/database/migrations/`
4. ‚úÖ **Ejecutar** migraci√≥n con `node scripts/run-migration.js`
5. ‚úÖ **Verificar** con `node scripts/verify-pages.js`
6. ‚úÖ **Probar** endpoint `/api/admin/menu/my-pages`
7. ‚úÖ **Confirmar** que aparece en el dashboard

**NO OMITIR NING√öN PASO.**

---

**√öltima actualizaci√≥n:** 2025-10-20
**Versi√≥n:** 1.0
**Autor:** Claude Code + BlueSystem Team
