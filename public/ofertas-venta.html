<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Sistema SAP - Ofertas de Venta</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/app-theme.css?v=2.0" rel="stylesheet">
    <style>
        :root {
            --sap-blue: #0070E0;
            --sap-light-blue: #E6F3FF;
            --sap-dark-blue: #003B6B;
            --sap-gray: #F7F7F7;
            --sap-border: #D9D9D9;
            --sap-text: #32363A;
            --sap-success: #107E3E;
            --sap-error: #E74C3C;
            --sap-warning: #F39C12;
            --bluesystem-accent: #0052CC;
            --sap-white: #FFFFFF;
            --sap-light-gray: #FAFAFA;
            --sap-medium-gray: #6A6D70;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: '72', 'Helvetica Neue', Arial, sans-serif;
            background: var(--sap-light-gray);
            color: var(--sap-text);
            line-height: 1.4;
            min-height: 100vh;
        }

        /* Header styles now in app-theme.css */

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 16px 24px;
            background: var(--sap-gray);
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            background: white;
            border-bottom-color: var(--sap-blue);
        }

        .tab:hover:not(.active) {
            background: #f0f0f0;
        }

        /* Content Panel */
        .content-panel {
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--sap-dark-blue);
            margin-bottom: 16px;
            border-bottom: 2px solid var(--sap-light-blue);
            padding-bottom: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--sap-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            padding: 12px;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--sap-blue);
            box-shadow: 0 0 0 2px rgba(0, 112, 224, 0.2);
        }

        .form-select {
            padding: 12px;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        /* Search Section */
        .search-section {
            background: var(--sap-light-blue);
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            align-items: end;
        }

        .search-btn {
            background: var(--sap-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .search-btn:hover {
            background: var(--sap-dark-blue);
        }

        /* Orders List */
        .orders-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .order-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }

        .order-item:hover {
            background: var(--sap-light-blue);
            border-left: 4px solid var(--sap-blue);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 112, 224, 0.2);
        }

        .order-item.selected {
            background: var(--sap-blue);
            color: white;
            border-left: 4px solid var(--sap-success);
        }

        .order-main-info {
            flex: 1;
        }

        .order-number {
            font-weight: 600;
            font-size: 16px;
        }

        .order-customer {
            font-size: 14px;
            color: var(--sap-medium-gray);
        }

        .order-item.selected .order-customer {
            color: rgba(255,255,255,0.8);
        }

        .order-amount {
            font-weight: 600;
            color: var(--sap-success);
        }

        .order-item.selected .order-amount {
            color: white;
        }

        /* Items Table */
        .items-section {
            margin-top: 24px;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .add-item-btn {
            background: var(--sap-success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .add-item-btn:hover {
            background: #0a5f2e;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            overflow: hidden;
        }

        .items-table th {
            background: var(--sap-gray);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--sap-border);
        }

        .items-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .items-table tr:hover {
            background: var(--sap-light-blue);
        }

        .item-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            font-size: 14px;
        }

        .remove-item-btn {
            background: var(--sap-error);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Actions */
        .actions-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--sap-border);
        }

        .quote-total {
            font-size: 18px;
            font-weight: 600;
            color: var(--sap-dark-blue);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--sap-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--sap-dark-blue);
        }

        .btn-secondary {
            background: var(--sap-border);
            color: var(--sap-text);
        }

        .btn-secondary:hover {
            background: var(--sap-medium-gray);
            color: white;
        }

        .btn-success {
            background: var(--sap-success);
            color: white;
        }

        .btn-success:hover {
            background: #0a5f2e;
        }

        /* Quotations List */
        .quotations-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--sap-border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
        }

        .quotations-table th {
            background: var(--sap-gray);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--sap-border);
        }

        .quotations-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .quotations-table tr:hover {
            background: var(--sap-light-blue);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-open {
            background: var(--sap-warning);
            color: white;
        }

        .status-approved {
            background: var(--sap-success);
            color: white;
        }

        .status-rejected {
            background: var(--sap-error);
            color: white;
        }

        /* Alert Messages */
        .alert {
            padding: 16px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 600;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert.success {
            background: #D4F5D4;
            border: 2px solid var(--sap-success);
            color: var(--sap-success);
        }

        .alert.error {
            background: #FFE6E6;
            border: 2px solid var(--sap-error);
            color: var(--sap-error);
        }

        .alert.warning {
            background: #FFF3CD;
            border: 2px solid var(--sap-warning);
            color: #856404;
        }

        .alert.info {
            background: var(--sap-light-blue);
            border: 2px solid var(--sap-blue);
            color: var(--sap-dark-blue);
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--sap-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Action Buttons in Table */
        .table-action-btn {
            background: var(--sap-blue);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-right: 4px;
        }

        .table-action-btn:hover {
            background: var(--sap-dark-blue);
        }

        .table-action-btn.success {
            background: var(--sap-success);
        }

        .table-action-btn.success:hover {
            background: #0a5f2e;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            background: var(--sap-blue);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            background: var(--sap-gray);
            border-radius: 0 0 8px 8px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Item row styles */
        .item-row-item {
            background: white;
        }

        .item-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-item {
            background: var(--sap-blue);
            color: white;
        }

        .stock-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .stock-ok {
            color: var(--sap-success);
        }

        .stock-low {
            color: var(--sap-warning);
        }

        .stock-none {
            color: var(--sap-error);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 0 16px;
                margin: 16px auto;
            }

            .form-grid,
            .search-grid {
                grid-template-columns: 1fr;
            }

            .actions-section {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .action-buttons {
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
    <!-- Session Manager para renovaci√≥n autom√°tica -->
    <script src="/js/sessionManager.js"></script>
</head>
<body>
    <!-- Professional Header -->
    <header class="main-header">
        <div class="header-left">
            <!-- App Brand -->
            <div class="app-brand">
                <img src="/images/logo-stia.png" alt="Logo" class="app-logo-img" onerror="this.style.display='none'">
                <span class="app-name" id="appName">Cargando...</span>
            </div>

            <span class="header-separator">|</span>

            <!-- Page Context -->
            <div class="page-context">
                <span class="page-icon">üíº</span>
                <h1 class="page-title-text">Ofertas de Venta</h1>
            </div>
        </div>

        <div class="header-right">
            <!-- SAP Connection Status Indicators -->
            <div class="connection-status">
                <span class="status-indicator" data-country="GT" title="Guatemala" id="status-gt">
                    <span class="status-dot"></span>
                    <span class="status-flag">üá¨üáπ</span>
                </span>
                <span class="status-indicator" data-country="HN" title="Honduras" id="status-hn">
                    <span class="status-dot"></span>
                    <span class="status-flag">üá≠üá≥</span>
                </span>
                <span class="status-indicator" data-country="PA" title="Panam√°" id="status-pa">
                    <span class="status-dot"></span>
                    <span class="status-flag">üáµüá¶</span>
                </span>
                <span class="status-indicator" data-country="CR" title="Costa Rica" id="status-cr">
                    <span class="status-dot"></span>
                    <span class="status-flag">üá®üá∑</span>
                </span>
            </div>

            <!-- Back Button -->
            <button class="btn btn-icon" onclick="goBack()" title="Regresar al Dashboard">
                <i class="fas fa-arrow-left"></i>
            </button>

            <!-- User Menu -->
            <div class="user-menu">
                <button class="user-trigger" onclick="toggleUserMenu(event)">
                    <span class="user-avatar">üë§</span>
                    <span class="user-name" id="username">Usuario</span>
                    <span class="dropdown-icon">‚ñº</span>
                </button>
                <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <div class="dropdown-header">
                        <div class="dropdown-user-name" id="dropdownUsername">Usuario</div>
                        <div class="dropdown-user-role">SAP User</div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="showUserProfile()">
                        <i class="fas fa-user"></i>
                        <span>Mi Perfil</span>
                    </button>
                    <button class="dropdown-item" onclick="showSystemInfo()">
                        <i class="fas fa-info-circle"></i>
                        <span>Informaci√≥n del Sistema</span>
                    </button>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item logout" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Alert Messages -->
        <div id="alert" class="alert"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="create">Nueva Oferta</button>
            <button class="tab" data-tab="list">Consultar Ofertas</button>
            <button class="tab" data-tab="reports">Reportes</button>
        </div>

        <!-- Content Panel -->
        <div class="content-panel">
            <!-- Create Quote Tab -->
            <div id="create-tab" class="tab-content active">
                <form id="quotationForm">
                    <!-- Company/Country Selection -->
                    <div class="form-section" style="background: #fffef5; padding: 12px 16px; border-radius: 4px; border-left: 4px solid var(--sap-warning); margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="flex-shrink: 0;">
                                <label class="form-label" style="margin-bottom: 4px;"><i class="fas fa-flag"></i> Pa√≠s/Compa√±√≠a *</label>
                            </div>
                            <div style="flex: 1; max-width: 350px;">
                                <select id="companyDB" class="form-select" required style="font-weight: 600;">
                                    <option value="">Seleccione un pa√≠s...</option>
                                    <option value="SBO_GT_STIA_PROD">üá¨üáπ Guatemala</option>
                                    <option value="SBO_HO_STIA_PROD">üá≠üá≥ Honduras</option>
                                    <option value="SBO_PA_STIA_PROD">üáµüá¶ Panam√°</option>
                                    <option value="SBO_STIACR_PROD">üá®üá∑ Costa Rica</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Selection -->
                    <div class="form-section">
                        <h3 class="section-title"><i class="fas fa-user"></i> 1. Selecci√≥n de Cliente</h3>

                        <!-- Customer Search -->
                        <div class="search-section">
                            <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--sap-dark-blue);">üîç Buscar Cliente</h4>
                            <div class="search-grid">
                                <div class="form-group">
                                    <label class="form-label">Buscar por C√≥digo</label>
                                    <input type="text" id="customerCodeSearch" class="form-input" placeholder="Escriba al menos 2 caracteres...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Buscar por Nombre</label>
                                    <input type="text" id="customerNameSearch" class="form-input" placeholder="Escriba al menos 3 caracteres...">
                                </div>
                                <button type="button" id="searchCustomersBtn" class="search-btn">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                            <small style="color: var(--sap-medium-gray); font-size: 12px; display: block; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> La b√∫squeda se realiza autom√°ticamente mientras escribe
                            </small>
                        </div>

                        <!-- Customer List -->
                        <div id="customerList" class="orders-list" style="display: none;"></div>

                        <!-- Selected Customer Info -->
                        <div id="selectedCustomerSection" style="display: none; margin-top: 20px; padding: 16px; background: #e6f7ff; border-left: 4px solid var(--sap-blue); border-radius: 4px;">
                            <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--sap-dark-blue);">‚úì Cliente Seleccionado</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">C√≥digo</label>
                                    <input type="text" id="selectedCustomerCode" class="form-input" readonly style="background: #f0f8ff; font-weight: 600;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" id="selectedCustomerName" class="form-input" readonly style="background: #f0f8ff; font-weight: 600;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quote Information -->
                    <div class="form-section">
                        <h3 class="section-title"><i class="fas fa-file-invoice"></i> 2. Informaci√≥n de la Oferta</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Fecha de Documento</label>
                                <input type="date" id="docDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Validez</label>
                                <input type="date" id="validUntil" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Comentarios</label>
                            <textarea id="comments" class="form-input" rows="3" placeholder="Comentarios adicionales..."></textarea>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="form-section items-section">
                        <div class="items-header">
                            <h3 class="section-title"><i class="fas fa-list"></i> 3. L√≠neas de la Oferta</h3>
                            <button type="button" id="addItemLineBtn" class="add-item-btn">
                                <i class="fas fa-box"></i> Agregar Art√≠culo
                            </button>
                        </div>

                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Tipo</th>
                                    <th style="width: 150px;">C√≥digo/Parte</th>
                                    <th>Descripci√≥n</th>
                                    <th style="width: 100px;">Cantidad</th>
                                    <th style="width: 120px;">Existencia (Alm.00)</th>
                                    <th style="width: 100px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <!-- Items will be added dynamically -->
                            </tbody>
                        </table>

                        <div id="noItemsMessage" style="text-align: center; padding: 40px; color: var(--sap-medium-gray); display: block;">
                            <i class="fas fa-inbox" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p>No hay art√≠culos agregados. Use el bot√≥n "Agregar Art√≠culo" para agregar productos a la oferta.</p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="actions-section">
                        <div class="quote-total">
                            <span style="color: var(--sap-medium-gray); font-size: 14px;">Total de l√≠neas: <strong id="itemCount">0</strong></span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">Limpiar</button>
                            <button type="submit" class="btn btn-primary">Crear Oferta de Venta</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- List Quotes Tab -->
            <div id="list-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Consultar Ofertas de Venta</h3>
                    
                    <!-- Search Filters -->
                    <div class="search-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de Oferta</label>
                                <input type="number" id="quoteNumSearch" class="form-input" placeholder="Buscar por n√∫mero...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">C√≥digo de Cliente</label>
                                <input type="text" id="quoteCustomerSearch" class="form-input" placeholder="Buscar por cliente...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha Desde</label>
                                <input type="date" id="quoteDateFromSearch" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha Hasta</label>
                                <input type="date" id="quoteDateToSearch" class="form-input">
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 16px;">
                            <button type="button" id="searchQuotesBtn" class="search-btn">Buscar Ofertas</button>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="quotesLoading" class="loading" style="display: none;">
                        <div class="spinner"></div>
                    </div>

                    <!-- Quotes Table -->
                    <table class="quotations-table">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>V√°lida Hasta</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Compa√±√≠a</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="quotesTableBody">
                            <!-- Quotes will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <div class="form-section">
                    <h3 class="section-title">Reportes de Ofertas de Venta</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Tipo de Reporte</label>
                            <select id="reportType" class="form-select">
                                <option value="summary">Resumen de Ofertas</option>
                                <option value="by-customer">Por Cliente</option>
                                <option value="by-date">Por Fecha</option>
                                <option value="conversion-rate">Tasa de Conversi√≥n</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" id="reportDateFrom" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" id="reportDateTo" class="form-input">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" id="generateReportBtn" class="btn btn-primary">Generar Reporte</button>
                    </div>

                    <div id="reportResults" style="margin-top: 30px; display: none;">
                        <h3 class="section-title">Resultados del Reporte</h3>
                        <div id="reportContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Search Modal -->
    <div id="itemSearchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-search"></i> Buscar Art√≠culo</h3>
                <button class="modal-close" onclick="closeItemSearchModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Search Form -->
                <div class="search-section" style="margin-bottom: 20px;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Buscar por C√≥digo</label>
                            <input type="text" id="itemCodeSearch" class="form-input" placeholder="C√≥digo de art√≠culo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Buscar por Nombre</label>
                            <input type="text" id="itemNameSearch" class="form-input" placeholder="Nombre del art√≠culo">
                        </div>
                        <div class="form-group">
                            <label class="form-label">N√∫mero de Parte</label>
                            <input type="text" id="itemPartSearch" class="form-input" placeholder="N√∫mero de parte">
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 16px;">
                        <button type="button" class="search-btn" onclick="searchItems()">
                            <i class="fas fa-search"></i> Buscar Art√≠culos
                        </button>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="itemSearchResults" style="display: none;">
                    <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--sap-dark-blue);">Resultados de B√∫squeda</h4>
                    <div class="orders-list" id="itemsList"></div>
                </div>

                <!-- No results message -->
                <div id="noItemsFound" style="display: none; text-align: center; padding: 40px; color: var(--sap-medium-gray);">
                    <i class="fas fa-box-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                    <p>No se encontraron art√≠culos con los criterios de b√∫squeda.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeItemSearchModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let sapAuth = null;
        let customers = [];
        let selectedCustomer = null;
        let quoteItems = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuthentication();
            if (sapAuth) {
                await loadAppConfig();
                updateHeaderUserInfo();
                updateConnectionStatus();
            }
            initializeTabs();
            initializeForm();
            setDefaultDates();
        });

        // Load app configuration
        async function loadAppConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // Update app name
                document.getElementById('appName').textContent = config.appName || 'STIA Multi-Regional';
                document.getElementById('pageTitle').textContent = `${config.appName || 'Sistema SAP'} - Ofertas de Venta`;

                console.log('App configuration loaded:', config);
            } catch (error) {
                console.error('Error loading app configuration:', error);
                // Fallback to default
                document.getElementById('appName').textContent = 'STIA Multi-Regional';
                document.getElementById('pageTitle').textContent = 'STIA Multi-Regional - Ofertas de Venta';
            }
        }

        // Update header user information
        function updateHeaderUserInfo() {
            if (!sapAuth) return;

            // Update username in both locations
            const usernameElement = document.getElementById('username');
            const dropdownUsername = document.getElementById('dropdownUsername');

            if (usernameElement) {
                usernameElement.textContent = sapAuth.username;
            }
            if (dropdownUsername) {
                dropdownUsername.textContent = sapAuth.username;
            }
        }

        // Update SAP connection status indicators
        function updateConnectionStatus() {
            if (!sapAuth || !sapAuth.sessions) return;

            const databaseMapping = {
                'SBO_GT_STIA_PROD': 'gt',
                'SBO_HO_STIA_PROD': 'hn',
                'SBO_PA_STIA_PROD': 'pa',
                'SBO_STIACR_PROD': 'cr'
            };

            // Update each indicator
            for (const [dbName, countryCode] of Object.entries(databaseMapping)) {
                const indicator = document.getElementById(`status-${countryCode}`);
                if (indicator) {
                    const session = sapAuth.sessions[dbName];
                    if (session && session.success) {
                        indicator.classList.add('online');
                        indicator.classList.remove('offline');
                    } else {
                        indicator.classList.add('offline');
                        indicator.classList.remove('online');
                    }
                }
            }
        }

        // Toggle user menu dropdown
        function toggleUserMenu(event) {
            event?.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                dropdown.style.display = isVisible ? 'none' : 'block';
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (event) => {
            const userMenu = event.target.closest('.user-menu');
            if (!userMenu) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }
        });

        // Show user profile (placeholder)
        function showUserProfile() {
            if (!sapAuth) return;

            alert(`Perfil de Usuario:\n\nUsuario: ${sapAuth.username}\nSesiones Activas: ${sapAuth.successCount}/${sapAuth.totalDatabases}\n\n[Funcionalidad en desarrollo]`);
            toggleUserMenu();
        }

        // Show system info (placeholder)
        function showSystemInfo() {
            if (!sapAuth) return;

            let info = '=== INFORMACI√ìN DEL SISTEMA ===\n\n';
            info += `Usuario: ${sapAuth.username}\n`;
            info += `Sesiones Activas: ${sapAuth.successCount}/${sapAuth.totalDatabases}\n\n`;
            info += 'Bases de Datos:\n';

            for (const [dbName, session] of Object.entries(sapAuth.sessions)) {
                const status = session.success ? '‚úì' : '‚úó';
                info += `  ${status} ${dbName}\n`;
            }

            alert(info);
            toggleUserMenu();
        }

        // Go back to dashboard
        function goBack() {
            window.location.href = '/dashboard';
        }

        // Check authentication
        function checkAuthentication() {
            const authData = localStorage.getItem('sapAuth');

            if (!authData) {
                showAlert('Debe iniciar sesi√≥n para acceder a este m√≥dulo', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }

            try {
                sapAuth = JSON.parse(authData);
            } catch (error) {
                console.error('Error parsing auth data:', error);
                showAlert('Error de autenticaci√≥n. Inicie sesi√≥n nuevamente.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            }
        }

        // Initialize tabs
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;

                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update active content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${targetTab}-tab`) {
                            content.classList.add('active');
                        }
                    });

                    // Load data based on tab
                    if (targetTab === 'list') {
                        loadQuotationsForAllCompanies();
                    }
                });
            });
        }

        // Initialize form
        function initializeForm() {
            // Company/Country change - reset customer selection
            document.getElementById('companyDB').addEventListener('change', () => {
                if (selectedCustomer) {
                    selectedCustomer = null;
                    document.getElementById('selectedCustomerCode').value = '';
                    document.getElementById('selectedCustomerName').value = '';
                    document.getElementById('selectedCustomerSection').style.display = 'none';
                    document.getElementById('customerList').style.display = 'none';
                    showAlert('Pa√≠s cambiado. Por favor, seleccione el cliente nuevamente.', 'info');
                }
            });

            // Customer search button
            document.getElementById('searchCustomersBtn').addEventListener('click', searchCustomers);

            // Live search while typing (with debouncing)
            let customerSearchTimeout = null;
            const customerCodeInput = document.getElementById('customerCodeSearch');
            const customerNameInput = document.getElementById('customerNameSearch');

            const performLiveSearch = () => {
                const code = customerCodeInput.value.trim();
                const name = customerNameInput.value.trim();

                if (code.length >= 2 || name.length >= 3) {
                    searchCustomers();
                }
            };

            customerCodeInput.addEventListener('input', () => {
                clearTimeout(customerSearchTimeout);
                customerSearchTimeout = setTimeout(performLiveSearch, 500);
            });

            customerNameInput.addEventListener('input', () => {
                clearTimeout(customerSearchTimeout);
                customerSearchTimeout = setTimeout(performLiveSearch, 500);
            });

            // Add item button
            document.getElementById('addItemLineBtn').addEventListener('click', openItemSearchModal);

            // Form submission
            document.getElementById('quotationForm').addEventListener('submit', createQuotation);

            // Search quotes
            document.getElementById('searchQuotesBtn').addEventListener('click', searchQuotations);

            // Generate report
            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const nextMonth = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('docDate').value = today;
            document.getElementById('validUntil').value = nextMonth;
        }

        // Search customers (same logic as sales orders)
        async function searchCustomers() {
            const customerCode = document.getElementById('customerCodeSearch').value.trim();
            const customerName = document.getElementById('customerNameSearch').value.trim();
            const companyDB = document.getElementById('companyDB').value;

            if (!companyDB) {
                showAlert('Debe seleccionar una compa√±√≠a primero', 'warning');
                return;
            }

            if (!customerCode && !customerName) {
                // Hide customer list if search is empty
                document.getElementById('customerList').style.display = 'none';
                return;
            }

            const session = getSessionForCompany(companyDB);
            if (!session) {
                showAlert(`No hay sesi√≥n activa para la compa√±√≠a seleccionada`, 'error');
                return;
            }

            try {
                // Show loading indicator without intrusive alert
                const customerList = document.getElementById('customerList');
                customerList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--sap-medium-gray);"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
                customerList.style.display = 'block';

                const response = await fetchWithAutoRenewal('/api/sap/business-partners', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        filters: {
                            cardCode: customerCode,
                            cardName: customerName,
                            cardType: 'C', // Customer type
                            limit: 20
                        }
                    })
                });

                const result = await response.json();

                console.log('Customer search result:', result);
                console.log('Customers found:', result.data?.value);

                if (result.success && result.data.value && result.data.value.length > 0) {
                    customers = result.data.value;
                    displayCustomers(customers);
                } else {
                    customerList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--sap-medium-gray);"><i class="fas fa-user-slash"></i> No se encontraron clientes</div>';
                }

            } catch (error) {
                console.error('Error searching customers:', error);
                customerList.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--sap-error);"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            }
        }

        // Display customers
        function displayCustomers(customers) {
            const customerList = document.getElementById('customerList');

            if (customers.length === 0) {
                customerList.style.display = 'none';
                return;
            }

            customerList.innerHTML = '';
            customers.forEach(customer => {
                console.log('Displaying customer:', customer);

                const customerItem = document.createElement('div');
                customerItem.className = 'order-item';
                customerItem.style.cursor = 'pointer';

                // Ensure we have at least the code or name
                const code = customer.CardCode || 'N/A';
                const name = customer.CardName || 'Sin nombre';
                const phone = customer.Phone1 ? `<br><small style="color: var(--sap-medium-gray);">Tel: ${customer.Phone1}</small>` : '';

                customerItem.innerHTML = `
                    <div class="order-main-info">
                        <div class="order-number"><strong>${code}</strong></div>
                        <div class="order-customer">
                            <strong>${name}</strong>${phone}
                            <br><small style="color: var(--sap-blue); margin-top: 4px; display: inline-block; font-weight: 600; animation: pulse 2s infinite;">
                                <i class="fas fa-hand-pointer"></i> HAZ CLIC AQU√ç PARA SELECCIONAR
                            </small>
                        </div>
                    </div>
                `;

                customerItem.addEventListener('click', (e) => {
                    console.log('Click detectado en cliente:', code);
                    selectCustomer(customer, e);
                });
                console.log('Event listener a√±adido para cliente:', code);
                customerList.appendChild(customerItem);
            });

            customerList.style.display = 'block';

            // AUTO-SELECCIONAR si solo hay UN cliente en los resultados
            if (customers.length === 1) {
                console.log('‚ö° Auto-seleccionando √∫nico cliente encontrado:', customers[0].CardCode);
                setTimeout(() => {
                    selectCustomer(customers[0], null);
                }, 500);
            }
        }

        // Select customer
        function selectCustomer(customer, event) {
            console.log('‚úì Seleccionando cliente:', customer.CardCode, customer.CardName);
            selectedCustomer = customer;

            // Update form fields
            document.getElementById('selectedCustomerCode').value = customer.CardCode;
            document.getElementById('selectedCustomerName').value = customer.CardName;

            // Show selected customer section
            document.getElementById('selectedCustomerSection').style.display = 'block';

            // Update UI
            document.querySelectorAll('.order-item').forEach(item => {
                item.classList.remove('selected');
            });

            if (event && event.target) {
                event.target.closest('.order-item').classList.add('selected');
            }

            // Show success message
            showAlert(`‚úì Cliente seleccionado: ${customer.CardName}`, 'success');

            // Hide customer list
            setTimeout(() => {
                document.getElementById('customerList').style.display = 'none';
            }, 500);

            console.log('‚úì Cliente seleccionado correctamente. selectedCustomer:', selectedCustomer);
        }

        // Open item search modal
        function openItemSearchModal() {
            console.log('Bot√≥n "Agregar Art√≠culo" presionado');
            console.log('Estado de selectedCustomer:', selectedCustomer);

            const companyDB = document.getElementById('companyDB').value;
            if (!companyDB) {
                console.warn('No se ha seleccionado una compa√±√≠a');
                showAlert('‚ö†Ô∏è PASO 1: Primero debe seleccionar un Pa√≠s/Compa√±√≠a', 'warning');
                // Scroll to company selection
                document.getElementById('companyDB').scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('companyDB').focus();
                return;
            }

            if (!selectedCustomer) {
                console.warn('No se ha seleccionado un cliente');
                console.warn('Valor actual de selectedCustomer:', selectedCustomer);
                console.warn('Tipo de selectedCustomer:', typeof selectedCustomer);

                // Check if there are customers in the list
                const customerList = document.getElementById('customerList');
                const hasCustomersInList = customerList.style.display === 'block' && customerList.children.length > 0;

                if (hasCustomersInList) {
                    showAlert('‚ö†Ô∏è IMPORTANTE: Debe hacer CLIC sobre el cliente en la lista de resultados para seleccionarlo. Vea el mensaje "HAZ CLIC AQU√ç PARA SELECCIONAR" en azul.', 'warning');
                } else {
                    showAlert('‚ö†Ô∏è PASO 2: Debe buscar un cliente primero. Use el campo de b√∫squeda "Buscar por C√≥digo" o "Buscar por Nombre" en la Secci√≥n 1.', 'warning');
                }

                // Resaltar la secci√≥n de b√∫squeda de clientes
                const customerSearchSection = document.querySelector('.search-section');
                if (customerSearchSection) {
                    customerSearchSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Focus on search field
                const customerCodeSearch = document.getElementById('customerCodeSearch');
                if (customerCodeSearch && !hasCustomersInList) {
                    setTimeout(() => customerCodeSearch.focus(), 500);
                }

                return;
            }

            console.log('‚úì Cliente seleccionado. Abriendo modal de b√∫squeda de art√≠culos');
            document.getElementById('itemSearchModal').style.display = 'block';
            document.getElementById('itemCodeSearch').value = '';
            document.getElementById('itemNameSearch').value = '';
            document.getElementById('itemPartSearch').value = '';
            document.getElementById('itemSearchResults').style.display = 'none';
            document.getElementById('noItemsFound').style.display = 'none';
        }

        // Close item search modal
        function closeItemSearchModal() {
            document.getElementById('itemSearchModal').style.display = 'none';
        }

        // Search items in SAP
        async function searchItems() {
            const itemCode = document.getElementById('itemCodeSearch').value.trim();
            const itemName = document.getElementById('itemNameSearch').value.trim();
            const itemPart = document.getElementById('itemPartSearch').value.trim();
            const companyDB = document.getElementById('companyDB').value;

            if (!itemCode && !itemName && !itemPart) {
                showAlert('Ingrese al menos un criterio de b√∫squeda', 'warning');
                return;
            }

            const session = getSessionForCompany(companyDB);
            if (!session) {
                showAlert('No hay sesi√≥n activa para la compa√±√≠a seleccionada', 'error');
                return;
            }

            try {
                showAlert('Buscando art√≠culos...', 'info');

                const response = await fetchWithAutoRenewal('/api/sap/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        filters: {
                            itemCode: itemCode,
                            itemName: itemName,
                            supplierCatalogNo: itemPart,
                            warehouse: '00',
                            limit: 20
                        }
                    })
                });

                const result = await response.json();

                if (result.success && result.data.value && result.data.value.length > 0) {
                    displayItems(result.data.value);
                    document.getElementById('itemSearchResults').style.display = 'block';
                    document.getElementById('noItemsFound').style.display = 'none';
                    hideAlert();
                } else {
                    document.getElementById('itemSearchResults').style.display = 'none';
                    document.getElementById('noItemsFound').style.display = 'block';
                    hideAlert();
                }

            } catch (error) {
                console.error('Error searching items:', error);
                showAlert('Error al buscar art√≠culos: ' + error.message, 'error');
            }
        }

        // Display items in modal
        function displayItems(items) {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';

            items.forEach(item => {
                // Get stock for warehouse 00
                const warehouse00 = item.ItemWarehouseInfoCollection?.find(w => w.WarehouseCode === '00');
                const stock = warehouse00?.InStock || 0;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                itemDiv.innerHTML = `
                    <div class="order-main-info">
                        <div class="order-number">${item.ItemCode}</div>
                        <div class="order-customer">${item.ItemName || 'Sin descripci√≥n'}</div>
                        ${item.SupplierCatalogNo ? `<div style="font-size: 11px; color: var(--sap-medium-gray);">Parte: ${item.SupplierCatalogNo}</div>` : ''}
                    </div>
                    <div class="order-amount stock-indicator ${stock > 10 ? 'stock-ok' : stock > 0 ? 'stock-low' : 'stock-none'}">
                        <i class="fas fa-cube"></i> ${stock.toFixed(2)}
                    </div>
                `;

                itemDiv.addEventListener('click', () => selectItem(item, stock));
                itemsList.appendChild(itemDiv);
            });
        }

        // Select item and add to quotation
        function selectItem(item, stock) {
            const tableBody = document.getElementById('itemsTableBody');
            const itemId = Date.now();

            const row = document.createElement('tr');
            row.classList.add('item-row-item');
            row.dataset.itemId = itemId;
            row.dataset.lineType = 'item';
            row.dataset.itemCode = item.ItemCode;
            row.innerHTML = `
                <td><span class="item-type-badge badge-item">ART√çCULO</span></td>
                <td>${item.ItemCode}${item.SupplierCatalogNo ? `<br><small style="color: var(--sap-medium-gray);">Parte: ${item.SupplierCatalogNo}</small>` : ''}</td>
                <td>${item.ItemName || ''}</td>
                <td><input type="number" class="item-input" min="1" value="1" style="width: 80px;"></td>
                <td><span class="stock-indicator ${stock > 10 ? 'stock-ok' : stock > 0 ? 'stock-low' : 'stock-none'}">
                    <i class="fas fa-cube"></i> ${stock.toFixed(2)}
                </span></td>
                <td><button type="button" class="remove-item-btn" onclick="removeItem(${itemId})">Eliminar</button></td>
            `;

            tableBody.appendChild(row);
            updateItemCount();
            document.getElementById('noItemsMessage').style.display = 'none';
            closeItemSearchModal();
            showAlert(`Art√≠culo ${item.ItemCode} agregado`, 'success');
        }

        // Remove item
        function removeItem(itemId) {
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            row.remove();
            updateItemCount();

            // Show empty message if no items
            const tableBody = document.getElementById('itemsTableBody');
            if (tableBody.children.length === 0) {
                document.getElementById('noItemsMessage').style.display = 'block';
            }
        }

        // Update item count
        function updateItemCount() {
            const tableBody = document.getElementById('itemsTableBody');
            const count = tableBody.children.length;
            document.getElementById('itemCount').textContent = count;
        }

        // Create quotation
        async function createQuotation(event) {
            event.preventDefault();
            
            if (!selectedCustomer) {
                showAlert('Debe seleccionar un cliente', 'error');
                return;
            }

            const companyDB = document.getElementById('companyDB').value;
            if (!companyDB) {
                showAlert('Debe seleccionar una compa√±√≠a', 'error');
                return;
            }

            // Validate items
            const itemRows = document.querySelectorAll('#itemsTableBody tr');
            if (itemRows.length === 0) {
                showAlert('Debe agregar al menos una l√≠nea', 'error');
                return;
            }

            // Prepare document lines
            const documentLines = [];
            let isValid = true;

            itemRows.forEach((row, index) => {
                // Item line
                const itemCode = row.dataset.itemCode;
                const quantityInput = row.children[3].querySelector('input');
                const quantity = quantityInput ? parseFloat(quantityInput.value) : 0;

                if (!itemCode || !quantity || quantity <= 0) {
                    showAlert(`L√≠nea ${index + 1}: C√≥digo y cantidad son obligatorios`, 'error');
                    isValid = false;
                    return;
                }

                documentLines.push({
                    ItemCode: itemCode,
                    Quantity: quantity,
                    WarehouseCode: '00'  // Almac√©n por defecto
                });
            });

            if (!isValid) return;

            const session = getSessionForCompany(companyDB);
            if (!session) {
                showAlert('No hay sesi√≥n activa para la compa√±√≠a seleccionada', 'error');
                return;
            }

            const quotationData = {
                CardCode: selectedCustomer.CardCode,
                CardName: selectedCustomer.CardName,
                DocDate: document.getElementById('docDate').value,
                ValidUntil: document.getElementById('validUntil').value,
                Comments: document.getElementById('comments').value,
                NumAtCard: sapAuth.username, // Referencia requerida por SAP - c√≥digo del usuario
                DocumentLines: documentLines
            };

            try {
                showAlert('Creando oferta de venta...', 'info');

                console.log('üì§ Datos a enviar:', {
                    sessionId: session.sessionId,
                    companyDB: companyDB,
                    quotationData: quotationData
                });

                const response = await fetchWithAutoRenewal('/api/sap/create-quotation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        quotationData: quotationData
                    })
                });

                const result = await response.json();
                console.log('üì• Respuesta del servidor:', result);

                if (result.success) {
                    showAlert(`‚úÖ Oferta de venta ${result.docNum} creada exitosamente`, 'success');
                    clearForm();
                } else {
                    console.error('‚ùå Error del servidor:', result);
                    let errorMsg = result.error || result.message || 'Error desconocido';

                    // Si hay detalles del error de SAP, mostrarlos
                    if (result.details) {
                        console.error('‚ùå Detalles del error SAP:', result.details);
                        try {
                            const sapError = typeof result.details === 'string' ? JSON.parse(result.details) : result.details;
                            if (sapError.error && sapError.error.message) {
                                errorMsg += ': ' + sapError.error.message.value;
                            }
                        } catch (e) {
                            errorMsg += ': ' + result.details;
                        }
                    }

                    showAlert('Error al crear la oferta: ' + errorMsg, 'error');
                }

            } catch (error) {
                console.error('‚ùå Error creating quotation:', error);
                showAlert('Error al crear la oferta: ' + error.message, 'error');
            }
        }

        // Load quotations for all companies
        async function loadQuotationsForAllCompanies() {
            const quotesTableBody = document.getElementById('quotesTableBody');
            quotesTableBody.innerHTML = '';

            showQuotesLoading(true);

            for (const [companyDB, session] of Object.entries(sapAuth.sessions)) {
                if (session && session.success) {
                    await loadQuotationsForCompany(companyDB, session.sessionId);
                }
            }

            showQuotesLoading(false);
        }

        // Load quotations for specific company
        async function loadQuotationsForCompany(companyDB, sessionId) {
            try {
                const response = await fetchWithAutoRenewal('/api/sap/quotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        companyDB: companyDB,
                        filters: { limit: 20 }
                    })
                });

                const result = await response.json();
                
                if (result.success && result.data.value) {
                    displayQuotations(result.data.value, companyDB);
                }

            } catch (error) {
                console.error(`Error loading quotations for ${companyDB}:`, error);
            }
        }

        // Display quotations
        function displayQuotations(quotations, companyDB) {
            const quotesTableBody = document.getElementById('quotesTableBody');
            const companyName = getCompanyName(companyDB);
            
            quotations.forEach(quotation => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${quotation.DocNum}</td>
                    <td>${quotation.CardCode} - ${quotation.CardName}</td>
                    <td>${new Date(quotation.DocDate).toLocaleDateString()}</td>
                    <td>${quotation.ValidUntil ? new Date(quotation.ValidUntil).toLocaleDateString() : 'N/A'}</td>
                    <td>$${(quotation.DocTotal || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${quotation.DocumentStatus === 'O' ? 'status-open' : quotation.DocumentStatus === 'A' ? 'status-approved' : 'status-rejected'}">${getQuotationStatus(quotation.DocumentStatus)}</span></td>
                    <td>${companyName}</td>
                    <td>
                        <button class="table-action-btn" onclick="viewQuotation(${quotation.DocEntry}, '${companyDB}')">Ver</button>
                        ${quotation.DocumentStatus === 'O' ? `<button class="table-action-btn success" onclick="convertToOrder(${quotation.DocEntry}, '${companyDB}')">Convertir</button>` : ''}
                    </td>
                `;
                quotesTableBody.appendChild(row);
            });
        }

        // Get quotation status text
        function getQuotationStatus(status) {
            const statusMap = {
                'O': 'Abierta',
                'A': 'Aprobada',
                'C': 'Cerrada',
                'R': 'Rechazada'
            };
            return statusMap[status] || status;
        }

        // Search quotations
        async function searchQuotations() {
            const quoteNum = document.getElementById('quoteNumSearch').value.trim();
            const customerCode = document.getElementById('quoteCustomerSearch').value.trim();
            const dateFrom = document.getElementById('quoteDateFromSearch').value;
            const dateTo = document.getElementById('quoteDateToSearch').value;

            const quotesTableBody = document.getElementById('quotesTableBody');
            quotesTableBody.innerHTML = '';
            
            showQuotesLoading(true);

            const filters = {};
            if (quoteNum) filters.docNum = quoteNum;
            if (customerCode) filters.cardCode = customerCode;
            if (dateFrom) filters.dateFrom = dateFrom;
            if (dateTo) filters.dateTo = dateTo;

            for (const [companyDB, session] of Object.entries(sapAuth.sessions)) {
                if (session && session.success) {
                    try {
                        const response = await fetchWithAutoRenewal('/api/sap/quotations', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sessionId: session.sessionId,
                                companyDB: companyDB,
                                filters: { ...filters, limit: 50 }
                            })
                        });

                        const searchResult = await response.json();
                        
                        if (searchResult.success && searchResult.data.value) {
                            displayQuotations(searchResult.data.value, result.companyDB);
                        }

                    } catch (error) {
                        console.error(`Error searching quotations for ${result.companyDB}:`, error);
                    }
                }
            }

            showQuotesLoading(false);
        }

        // View quotation details
        function viewQuotation(docEntry, companyDB) {
            showAlert(`Vista detallada de la Oferta ${docEntry} en desarrollo`, 'info');
        }

        // Convert quotation to sales order
        async function convertToOrder(docEntry, companyDB) {
            if (!confirm('¬øEst√° seguro de que desea convertir esta oferta a orden de venta?')) {
                return;
            }

            const session = getSessionForCompany(companyDB);
            if (!session) {
                showAlert('No hay sesi√≥n activa para la compa√±√≠a seleccionada', 'error');
                return;
            }

            try {
                showAlert('Convirtiendo oferta a orden de venta...', 'info');

                const response = await fetchWithAutoRenewal('/api/sap/convert-quotation-to-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        quotationDocEntry: docEntry
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`‚úÖ ${result.message}`, 'success');
                    // Reload quotations to reflect status change
                    loadQuotationsForAllCompanies();
                } else {
                    showAlert('Error al convertir oferta: ' + (result.error || 'Error desconocido'), 'error');
                }

            } catch (error) {
                console.error('Error converting quotation to order:', error);
                showAlert('Error al convertir oferta: ' + error.message, 'error');
            }
        }

        // Generate report
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            showAlert(`Generando reporte de tipo: ${reportType}`, 'info');
            
            // Implement report generation logic here
            setTimeout(() => {
                const reportResults = document.getElementById('reportResults');
                const reportContent = document.getElementById('reportContent');
                reportContent.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--sap-medium-gray);">
                        üìä Reporte "${reportType}" en desarrollo.<br>
                        <small>Se integrar√° con los datos reales de ofertas de venta.</small>
                    </div>
                `;
                reportResults.style.display = 'block';
            }, 1000);
        }

        // Clear form
        function clearForm() {
            document.getElementById('quotationForm').reset();
            document.getElementById('selectedCustomerCode').value = '';
            document.getElementById('selectedCustomerName').value = '';
            document.getElementById('itemsTableBody').innerHTML = '';
            document.getElementById('itemCount').textContent = '0';
            document.getElementById('customerList').style.display = 'none';
            document.getElementById('selectedCustomerSection').style.display = 'none';
            document.getElementById('noItemsMessage').style.display = 'block';

            selectedCustomer = null;
            customers = [];
            quoteItems = [];

            setDefaultDates();
        }

        // Helper functions
        function getSessionForCompany(companyDB) {
            if (!sapAuth) {
                console.error('sapAuth is not available');
                return null;
            }

            console.log('sapAuth structure:', sapAuth);

            // Handle different sapAuth structures
            if (sapAuth.sessions && typeof sapAuth.sessions === 'object') {
                // Multi-company login with sessions object
                const session = sapAuth.sessions[companyDB];
                if (session && session.success) {
                    return {
                        sessionId: session.sessionId,
                        companyDB: companyDB,
                        success: true
                    };
                }
            } else if (sapAuth.companyDB === companyDB && sapAuth.sessionId) {
                // Single company login
                return {
                    sessionId: sapAuth.sessionId,
                    companyDB: sapAuth.companyDB,
                    success: true
                };
            } else if (sapAuth.sessionId) {
                // Fallback: use the session for the requested company
                return {
                    sessionId: sapAuth.sessionId,
                    companyDB: companyDB,
                    success: true
                };
            }

            console.error('No valid session found for company:', companyDB);
            return null;
        }

        function getCompanyName(companyDB) {
            const companyNames = {
                'SBO_GT_STIA_PROD': 'Guatemala',
                'SBO_HO_STIA_PROD': 'Honduras',
                'SBO_PA_STIA_PROD': 'Panam√°',
                'SBO_STIACR_PROD': 'Costa Rica'
            };
            return companyNames[companyDB] || companyDB;
        }

        function showQuotesLoading(show) {
            const loadingElement = document.getElementById('quotesLoading');
            loadingElement.style.display = show ? 'block' : 'none';
        }

        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';

            // Scroll to alert
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            if (type !== 'error') {
                setTimeout(() => {
                    hideAlert();
                }, 5000);
            }
        }

        function hideAlert() {
            const alert = document.getElementById('alert');
            alert.style.display = 'none';
        }

        console.log('Sales Quotes page loaded successfully');
    </script>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-left">
                <span class="bluesystem-brand">BlueSystemIO</span>
                <span>2025</span>
            </div>
            <div class="footer-right">
                <span>Version 1.0.0</span>
            </div>
        </div>
    </footer>
    <!-- Inactivity Manager - Auto logout after 5 minutes of inactivity -->
    <script src="/js/inactivityManager.js"></script>
</body>
</html>